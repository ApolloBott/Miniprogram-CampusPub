<view class="publish-page"><view class="content-section"><view class="content-header"><text class="header-title">分享新鲜事</text></view><textarea class="content-input" placeholder="分享新鲜事..." placeholder-class="content-placeholder" maxlength="{{500}}" auto-height="{{true}}" data-event-opts="{{[['input',[['__set_model',['','postContent','$event',[]]]]]]}}" value="{{postContent}}" bindinput="__e"></textarea><view class="content-with-tags"><block wx:if="{{$root.g0>0}}"><view class="inline-tags"><block wx:for="{{selectedTagsInContent}}" wx:for-item="tag" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['removeTag',['$0'],[[['selectedTagsInContent','',index]]]]]]]}}" class="tag-badge" bindtap="__e"><text class="tag-text">{{"#"+tag}}</text></view></block></view></block></view><view class="content-count"><text class="{{[($root.g1>500)?'over-limit':'']}}">{{''+$root.g2+'/500'}}</text><block wx:if="{{$root.g3>0}}"><text class="tag-count">{{'已选 '+$root.g4+'/3 个标签'}}</text></block></view><block wx:if="{{$root.g5>0}}"><view class="available-tags"><block wx:for="{{availableTags}}" wx:for-item="tag" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['addTag',['$0'],[[['availableTags','',index]]]]]]]}}" class="tag-item available" bindtap="__e"><text class="tag-text">{{"#"+tag}}</text></view></block></view></block><block wx:if="{{$root.g6}}"><view class="images-grid"><block wx:for="{{selectedImages}}" wx:for-item="img" wx:for-index="index" wx:key="index"><view class="image-item"><image class="image" src="{{img}}" mode="aspectFill"></image><view data-event-opts="{{[['tap',[['deleteImage',[index]]]]]}}" class="delete-icon" bindtap="__e"><text>×</text></view></view></block><block wx:if="{{$root.g7}}"><view data-event-opts="{{[['tap',[['chooseImage',['$event']]]]]}}" class="add-image-btn" bindtap="__e"><text class="add-icon">+</text><text class="add-text">添加图片</text></view></block><block wx:if="{{uploading}}"><view class="add-image-btn uploading"><text class="add-icon">⏳</text><text class="add-text">上传中...</text></view></block></view></block></view><block wx:if="{{$root.g8}}"><view class="goods-link-section"><text class="section-title">商品关联（可选）</text><view data-event-opts="{{[['tap',[['toggleGoodsLink',['$event']]]]]}}" class="goods-link-toggle" bindtap="__e"><text class="toggle-label">关联我发布的商品</text><view class="{{['toggle-switch',(enableGoodsLink)?'active':'']}}"><view class="toggle-circle"></view></view></view><block wx:if="{{enableGoodsLink&&selectedGoods}}"><view class="selected-goods"><view data-event-opts="{{[['tap',[['gotoSelectGoods',['$event']]]]]}}" class="goods-card" bindtap="__e"><image class="goods-image" src="{{selectedGoods.goods_small_logo||selectedGoods.goods_big_logo}}" mode="aspectFill"></image><view class="goods-info"><text class="goods-name">{{selectedGoods.goods_name}}</text><text class="goods-price">{{"¥"+selectedGoods.goods_price}}</text></view><text class="change-btn">更换</text></view></view></block><block wx:if="{{enableGoodsLink&&!selectedGoods}}"><view data-event-opts="{{[['tap',[['gotoSelectGoods',['$event']]]]]}}" class="select-goods-btn" bindtap="__e"><text class="select-icon">📦</text><text class="select-text">选择商品</text></view></block><block wx:if="{{enableGoodsLink}}"><view class="goods-tips"><text>💡 关联商品后，用户可以直接查看商品详情</text></view></block></view></block><view class="contact-section"><text class="section-title">联系方式（可选）</text><view data-event-opts="{{[['tap',[['toggleContact',['$event']]]]]}}" class="contact-toggle" bindtap="__e"><text class="toggle-label">允许他人联系我</text><view class="{{['toggle-switch',(enableContact)?'active':'']}}"><view class="toggle-circle"></view></view></view><block wx:if="{{enableContact}}"><view class="contact-input-container"><view class="input-label"><text>联系方式</text><text class="input-tip">请输入微信号或QQ号</text></view><input class="contact-input" placeholder="请输入微信号或QQ号" placeholder-class="input-placeholder" maxlength="{{50}}" data-event-opts="{{[['input',[['__set_model',['','contactInfo','$event',[]]]]]]}}" value="{{contactInfo}}" bindinput="__e"/><view class="contact-tips"><text>💡 提示：他人可点击"联系TA"复制您的联系方式，没有校园认证的用户无法获取您的联系方式</text></view></view></block></view><view class="department-section"><text class="section-title">发布范围（可选）</text><view class="only-myself-option"><view data-event-opts="{{[['tap',[['toggleOnlyMyself',['$event']]]]]}}" class="option-header" bindtap="__e"><view class="option-left"><text class="option-label">仅自己可见</text><text class="option-desc">开启后该帖子只有你能看到</text></view><view class="{{['toggle-switch',(onlyMyself)?'active':'']}}"><view class="toggle-circle"></view></view></view></view><view class="department-tip"><text>💡 提示：不能同时设置"不发布到"和"只发布到"</text></view></view><view data-event-opts="{{[['tap',[['publishPost',['$event']]]]]}}" class="{{['publish-btn',(isPublishing)?'disabled':'']}}" bindtap="__e"><text>{{isPublishing?'发布中...':'发布'}}</text></view><block wx:if="{{showModal}}"><view data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="department-modal" bindtap="__e"><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="modal-content" catchtap="__e"><view class="modal-header"><text class="modal-title">{{''+(modalType==='exclude'?'选择不发布的院系（可多选）':'选择只发布的院系')+''}}</text><text data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="modal-close" bindtap="__e">×</text></view><scroll-view class="modal-body" scroll-y="{{true}}"><block wx:for="{{$root.l0}}" wx:for-item="dept" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['toggleDepartment',['$0'],[[['displayDepartments','',index]]]]]]]}}" class="{{['department-item',(dept.m0)?'selected':'']}}" bindtap="__e"><text class="department-name">{{dept.$orig}}</text><block wx:if="{{dept.m1}}"><text class="department-check">✓</text></block></view></block><block wx:if="{{modalType==='include'&&!userBase.major}}"><view class="empty-tip"><text class="empty-icon">📋</text><text class="empty-text">您的个人信息中未设置院系</text></view></block></scroll-view><view class="modal-footer"><view data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="modal-btn cancel" bindtap="__e"><text>取消</text></view><view data-event-opts="{{[['tap',[['confirmDepartments',['$event']]]]]}}" class="modal-btn confirm" bindtap="__e"><text>确定</text></view></view></view></view></block></view>