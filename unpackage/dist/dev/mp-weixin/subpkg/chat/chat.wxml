<view class="chat-container"><view class="header"><view class="seller-info"><block wx:if="{{goods_info.publisher_id!==userBase.openid}}"><text class="seller-name">{{goods_info.publisher_nickname}}</text></block><block wx:else><text class="seller-name">{{other_nickname}}</text></block></view><view data-event-opts="{{[['tap',[['showMoreOptions',['$event']]]]]}}" class="more-btn" bindtap="__e"><image class="more_icons" src="/static/icons/more.png"></image></view></view><view class="goods-bar"><image class="goods-image" src="{{goods_info.goods_big_logo}}" mode="aspectFill" data-event-opts="{{[['tap',[['gotoDetail',['$0'],['goods_info']]]]]}}" bindtap="__e"></image><view class="goods-info"><text class="goods-name">{{displayGoodsName}}</text><text class="goods-price">{{"¥"+goods_info.goods_price}}</text></view><block wx:if="{{goods_info.publisher_id!==userBase.openid}}"><view><block wx:if="{{transactionStatus===0}}"><view data-event-opts="{{[['tap',[['buyNow',['$event']]]]]}}" class="buy-btn" bindtap="__e">线下交易</view></block><block wx:else><block wx:if="{{transactionStatus===1}}"><view class="waiting-btn">等待卖家确认</view></block><block wx:else><block wx:if="{{transactionStatus===2}}"><view data-event-opts="{{[['tap',[['finish',['$event']]]]]}}" class="in-progress-btn" bindtap="__e">确认交易完成</view></block><block wx:else><block wx:if="{{transactionStatus===3}}"><view class="completed-btn">交易已完成</view></block></block></block></block></view></block><block wx:else><view><block wx:if="{{transactionStatus===1}}"><view data-event-opts="{{[['tap',[['agreeTransaction',['$event']]]]]}}" class="agree-btn" bindtap="__e">同意线下交易</view></block><block wx:else><block wx:if="{{transactionStatus===2}}"><view class="in-progress-btn">线下交易进行中</view></block><block wx:else><block wx:if="{{transactionStatus===3}}"><view class="completed-btn">交易已完成</view></block><block wx:else><view class="no-transaction-btn">等待买家发起</view></block></block></block></view></block></view><scroll-view class="chat-content" scroll-y="{{true}}" scroll-into-view="{{scrollIntoView}}" scroll-with-animation="{{true}}" lower-threshold="{{scrollThreshold}}" data-event-opts="{{[['scroll',[['handleScroll',['$event']]]],['scrolltolower',[['handleScrollToLower',['$event']]]]]}}" bindscroll="__e" bindscrolltolower="__e"><block wx:for="{{$root.l0}}" wx:for-item="msg" wx:for-index="index" wx:key="index"><view class="message-item" id="{{'msg-'+index}}"><block wx:if="{{msg.$orig.showTime}}"><view class="message-time">{{''+msg.$orig.time+''}}</view></block><block wx:if="{{msg.$orig.type==='system'}}"><view class="system-message"><text class="system-text">{{msg.$orig.content}}</text></view></block><block wx:if="{{msg.$orig.type==='received'}}"><view class="message-wrapper left"><block wx:if="{{goods_info.publisher_id!==openid}}"><image class="avatar" src="{{goods_info.publisher_avatarUrl}}" mode="aspectFill"></image></block><block wx:else><image class="avatar" src="{{other_avatarUrl}}" mode="aspectFill"></image></block><view class="message-content"><block wx:if="{{msg.$orig.message_type==='text'||!msg.$orig.message_type}}"><view class="{{['message-bubble','left-bubble',(msg.$orig.is_payment)?'payment-message':'']}}"><rich-text nodes="{{msg.m0}}"></rich-text></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='image'}}"><image class="message-image" src="{{msg.$orig.content}}" mode="aspectFill" data-event-opts="{{[['tap',[['previewImage',['$0'],[[['messages','',index,'content']]]]]]]}}" bindtap="__e"></image></block><block wx:else><block wx:if="{{msg.$orig.message_type==='emoji'}}"><image class="message-emoji" src="{{msg.$orig.content}}" mode="aspectFit" data-event-opts="{{[['tap',[['previewEmoji',['$0'],[[['messages','',index,'content']]]]]]]}}" bindtap="__e"></image></block><block wx:else><block wx:if="{{msg.$orig.message_type==='transaction'}}"><view class="transaction-message left-transaction"><view class="transaction-header"><text class="transaction-icon">🤝</text><text class="transaction-title">发起线下交易</text></view><view class="transaction-body"><block wx:if="{{msg.$orig.location}}"><view class="transaction-item"><text class="label">见面地点:</text><text class="value location">{{msg.$orig.location}}</text></view></block><block wx:else><view class="transaction-item"><text class="label">见面地点:</text><text class="value tips">待协商</text></view></block></view><view class="transaction-footer"><text class="status-text">等待对方确认</text></view></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='agree'}}"><view class="{{['agree-message',msg.$orig.type==='sent'?'right-agree':'left-agree']}}"><view class="agree-header"><text class="agree-icon">✅</text><text class="agree-title">已同意线下交易</text></view><view class="agree-body"><view class="agree-item"><text class="tips-text">💬 请双方协商具体交易事宜</text></view></view><view class="agree-footer"><text class="status-text">交易进行中</text></view></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='finish'}}"><view class="finish-message left-finish"><view class="finish-header"><text class="finish-icon">🎉</text><text class="finish-title">交易已完成</text></view><view class="finish-body"><view class="finish-item"><text class="tips-text">✅ 感谢您的交易，期待下次合作</text></view></view><view class="finish-footer"><text class="status-text">交易成功</text></view></view></block></block></block></block></block></block></view></view></block><block wx:if="{{msg.$orig.type==='sent'}}"><view class="message-wrapper right"><view class="message-content"><block wx:if="{{msg.$orig.message_type==='text'||!msg.$orig.message_type}}"><view class="{{['message-bubble','right-bubble',(msg.$orig.is_payment)?'payment-message':'']}}"><rich-text nodes="{{msg.m1}}"></rich-text></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='image'}}"><image class="message-image" src="{{msg.$orig.content}}" mode="aspectFill" data-event-opts="{{[['tap',[['previewImage',['$0'],[[['messages','',index,'content']]]]]]]}}" bindtap="__e"></image></block><block wx:else><block wx:if="{{msg.$orig.message_type==='emoji'}}"><image class="message-emoji" src="{{msg.$orig.content}}" mode="aspectFit" data-event-opts="{{[['tap',[['previewEmoji',['$0'],[[['messages','',index,'content']]]]]]]}}" bindtap="__e"></image></block><block wx:else><block wx:if="{{msg.$orig.message_type==='transaction'}}"><view class="transaction-message right-transaction"><view class="transaction-header"><text class="transaction-icon">🤝</text><text class="transaction-title">发起线下交易</text></view><view class="transaction-body"><block wx:if="{{msg.$orig.location}}"><view class="transaction-item"><text class="label">见面地点:</text><text class="value location">{{msg.$orig.location}}</text></view></block><block wx:else><view class="transaction-item"><text class="label">见面地点:</text><text class="value tips">待协商</text></view></block></view><view class="transaction-footer"><text class="status-text">已发送交易请求</text></view></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='agree'}}"><view class="agree-message right-agree"><view class="agree-header"><text class="agree-icon">✅</text><text class="agree-title">已同意线下交易</text></view><view class="agree-body"><view class="agree-item"><text class="tips-text">💬 请双方协商具体交易事宜</text></view></view><view class="agree-footer"><text class="status-text">交易进行中</text></view></view></block><block wx:else><block wx:if="{{msg.$orig.message_type==='finish'}}"><view class="finish-message right-finish"><view class="finish-header"><text class="finish-icon">🎉</text><text class="finish-title">交易已完成</text></view><view class="finish-body"><view class="finish-item"><text class="tips-text">✅ 感谢您的交易，期待下次合作</text></view></view><view class="finish-footer"><text class="status-text">交易成功</text></view></view></block></block></block></block></block></block></view><image class="avatar" src="{{userBase.avatarUrl}}" mode="aspectFill"></image></view></block></view></block></scroll-view><view class="{{['emoji-panel',(showEmojiPanel)?'show':'']}}"><scroll-view class="emoji-scroll" scroll-y="{{true}}"><view class="emoji-grid"><block wx:for="{{emojiList}}" wx:for-item="emoji" wx:for-index="index" wx:key="index"><view data-event-opts="{{[['tap',[['selectEmoji',['$0'],[[['emojiList','',index]]]]]]]}}" class="emoji-item" bindtap="__e"><image class="emoji-image" src="{{emoji.url}}" mode="aspectFit"></image></view></block></view></scroll-view></view><view class="input-bar" style="{{'bottom:'+(showEmojiPanel?'250px':'0')+';'}}"><input class="input-field" placeholder="想跟TA说点什么..." confirm-type="send" data-event-opts="{{[['confirm',[['sendMessage',['$event']]]],['focus',[['e0',['$event']]]],['input',[['__set_model',['','inputText','$event',[]]]]]]}}" value="{{inputText}}" bindconfirm="__e" bindfocus="__e" bindinput="__e"/><view data-event-opts="{{[['tap',[['showEmojiPicker',['$event']]]]]}}" class="emoji-btn" bindtap="__e"><image style="width:56rpx;height:56rpx;" src="https://wait00.oss-cn-shanghai.aliyuncs.com/label/biaoqing.png" mode="aspectFit"></image></view><view data-event-opts="{{[['tap',[['showAddMenu',['$event']]]]]}}" class="add-btn" bindtap="__e"><image style="width:56rpx;height:56rpx;" src="https://wait00.oss-cn-shanghai.aliyuncs.com/label/jiahao.png" mode="aspectFit"></image></view></view><view data-event-opts="{{[['tap',[['scrollToBottomWithTip',['$event']]]]]}}" class="{{['new-message-tip',(showNewMessageTip)?'show':'']}}" bindtap="__e"><view class="tip-content"><text class="tip-icon">💬</text><text class="tip-text">{{newMessageCount+"条新消息"}}</text><text class="tip-arrow">👇</text></view></view><view data-event-opts="{{[['tap',[['closePurchasePopup',['$event']]]]]}}" class="{{['purchase-popup',(showPurchasePopup)?'show':'']}}" bindtap="__e"><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="popup-content" catchtap="__e"><view data-event-opts="{{[['tap',[['closePurchasePopup',['$event']]]]]}}" class="close-btn" bindtap="__e"><text class="iconfont">✕</text></view><view class="popup-goods-info"><image class="popup-goods-image" src="{{goods_info.goods_big_logo}}" mode="aspectFill"></image><view class="popup-goods-detail"><text class="popup-goods-name">{{goods_info.goods_name}}</text><text class="popup-goods-price">{{"¥"+goods_info.goods_price}}</text></view></view><view class="address-section"><view class="address-header"><text class="iconfont location-icon">📍</text><text class="address-title">期待线下交易地点</text><text class="address-tip">(选填)</text></view><view class="address-input-container"><textarea class="address-input" placeholder="请输入收货地址(可不填,付款后协商)" placeholder-class="address-placeholder" maxlength="200" auto-height="{{true}}" show-confirm-bar="{{false}}" data-event-opts="{{[['input',[['__set_model',['','addressInput','$event',[]]]]]]}}" value="{{addressInput}}" bindinput="__e"></textarea></view><block wx:if="{{$root.g0}}"><view data-event-opts="{{[['tap',[['saveAddress',['$event']]]]]}}" class="save-address-btn" catchtap="__e"><text>💾 保存地址</text></view></block><block wx:if="{{savedAddressText}}"><view class="saved-address"><text class="saved-label">已保存:</text><text class="saved-text">{{savedAddressText}}</text></view></block></view><view class="payment-section"><view data-event-opts="{{[['tap',[['handleWechatPay',['$event']]]]]}}" class="payment-button" bindtap="__e"><text class="transaction-icon">🤝</text><text class="payment-text">确认发起交易</text></view></view></view></view></view>